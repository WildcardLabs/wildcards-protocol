<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }

      @media (prefers-color-scheme: dark) {
        html, body {
          background-color: #3c3c3c;
        }
      }

      @media (prefers-color-scheme: light) {
        html, body {
          background-color: #ffffff;
        }
      }
    </style>
  </head>

  <body>
    <script type="module">
      function toHex(value, bytes = 32) {
        let hex = Number(value).toString(16);
        if (hex.length % 2) hex = '0' + hex;
        return '0'.repeat(bytes * 2 - hex.length) + hex;
      }

      function encodeGetString(id, key) {
        const selector = "0x90d182d6";
        const encodedId = toHex(id);
        const cleanKey = key.startsWith("0x") ? key.slice(2) : key;
        return selector + encodedId + cleanKey;
      }

      function sanitizeHtml(htmlContent) {
        // Remove potentially dangerous tags
        htmlContent = htmlContent.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
        htmlContent = htmlContent.replace(/<iframe[\s\S]*?>[\s\S]*?<\/iframe>/gi, '');
        htmlContent = htmlContent.replace(/<object[\s\S]*?>[\s\S]*?<\/object>/gi, '');
        htmlContent = htmlContent.replace(/<embed[\s\S]*?>[\s\S]*?<\/embed>/gi, '');
        htmlContent = htmlContent.replace(/\s+on\w+="[^"]*"/gi, '');
        htmlContent = htmlContent.replace(/\s+on\w+='[^']*'/gi, '');
        htmlContent = htmlContent.replace(/javascript:/gi, '');

        // Inject CSP meta tag
        const security = `<meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src 'self' data:; script-src 'none'; style-src 'self' 'unsafe-inline';">`;
        const headTagPattern = /<head[^>]*>/i;
        const cspMetaTagPattern = /<meta[^>]*http-equiv=["']Content-Security-Policy["'][^>]*>/i;

        if (!htmlContent.match(headTagPattern)) {
          htmlContent = `<head>${security}</head>` + htmlContent;
        } else {
          if (htmlContent.match(cspMetaTagPattern)) {
            htmlContent = htmlContent.replace(cspMetaTagPattern, '');
          }
          htmlContent = htmlContent.replace(headTagPattern, match => `${match}${security}`);
        }

        return htmlContent;
      }

      async function loadContent() {
        let idParam;
        const host = window.location.hostname;
        const firstLabel = host.split(".")[0];

        if (/^\d+$/.test(firstLabel)) {
          idParam = firstLabel;
        }

        if (idParam) {
          const key = "0xfc77a78c81db9794340a10dbcb0632f44d2d889f2cac2911b039a50f90ead7d0";
          const data = encodeGetString(idParam, key);

          const body = {
            jsonrpc: "2.0",
            id: 1,
            method: "eth_call",
            params: [
              {
                from: "0x0000000000000000000000000000000000000000",
                to: "0x04d7c8b512d5455e20df1e808f12cad1e3d766e5",
                data: data
              },
              "latest"
            ]
          };

          try {
            const res = await fetch("https://mainnet.base.org/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(body)
            });

            const json = await res.json();

            if (json.result) {
              const hex = json.result.slice(2);
              const offset = parseInt(hex.slice(0, 64), 16);
              const length = parseInt(hex.slice(64, 128), 16);
              const contentHex = hex.slice(128, 128 + length * 2);

              const bytes = new Uint8Array(length);
              for (let i = 0; i < length; i++) {
                bytes[i] = parseInt(contentHex.slice(i * 2, i * 2 + 2), 16);
              }

              const decoded = new TextDecoder().decode(bytes);
              const safeHtml = sanitizeHtml(decoded);
              document.open();
              document.write(safeHtml);
              document.close();
            } else {
              document.open();
              document.write(`
                <head>
                  <meta name="viewport" content="width=device-width, initial-scale=1">
                  <title>OK COMPUTER #${idParam}</title>
                </head>
                <body style="background-color: #101010; color: limegreen; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;">
                  <div style="max-width: 400px; text-align: center;">
                    <h2>[OK COMPUTER #${idParam}] hasn't setup their onchain webpage yet!</h2>
                    <img src="...your_base64_image_here..." />
                    <p>
                      <a style="color:#004cff;" target="_blank" href="https://opensea.io/item/base/0xce2830932889c7fb5e5206287c43554e673dcc88/${idParam}">
                        View [OK COMPUTERS #${idParam}] on Opensea
                      </a>
                    </p>
                  </div>
                </body>
              `);
              document.close();
            }
          } catch (e) {
            document.write("Request failed: " + e.message);
          }
        }
      }

      loadContent();
    </script>
  </body>
</html>
